import unittest

from urllib3.poolmanager import PoolManager
from urllib3 import connection_from_url


class TestPoolManager(unittest.TestCase):
    def test_same_url(self):
        # Convince ourselves that normally we don't get the same object
        conn1 = connection_from_url('http://localhost:8081/foo')
        conn2 = connection_from_url('http://localhost:8081/bar')

        self.assertNotEqual(conn1, conn2)

        # Now try again using the PoolManager
        p = PoolManager(1)

        conn1 = p.connection_from_url('http://localhost:8081/foo')
        conn2 = p.connection_from_url('http://localhost:8081/bar')

        self.assertEqual(conn1, conn2)

    def test_post_request(self):

       pool_manager = PoolManager()

       url = "http://www.snee.com/xml/crud/posttest.cgi"

       params = { "fname": "test firstname", "lname": "test lastname" }

       response = pool_manager.request(method="POST", url=url,
                                          fields=params)

       self.assertEqual(response.status, 200)

       self.assertTrue(response.data.find('''<p>First name: "test firstname"</p><p>Last
                           name: "test lastname"</p>'''))

    def test_many_urls(self):
        urls = [
            "http://localhost:8081/foo",
            "http://www.google.com/mail",
            "http://localhost:8081/bar",
            "https://www.google.com/",
            "https://www.google.com/mail",
            "http://yahoo.com",
            "http://bing.com",
            "http://yahoo.com/",
        ]

        connections = set()

        p = PoolManager(10)

        for url in urls:
            conn = p.connection_from_url(url)
            connections.add(conn)

        self.assertEqual(len(connections), 5)


if __name__ == '__main__':
    unittest.main()
